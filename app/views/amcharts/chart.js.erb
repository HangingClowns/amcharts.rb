// If the container element doesn't already exist, create it
if (!document.getElementById('<%= container %>'))
{
  var container = document.createElement("DIV");
  container.className = 'chart';
  container.id = '<%= container %>';
  container.style.width = '<%= chart.width %>px';
  container.style.height = '<%= chart.height %>px';

  var scripts = document.getElementsByTagName('script');
  var this_script = scripts[scripts.length - 1];
  this_script.parentNode.insertBefore(container, this_script);
}

<%# TODO: This should be cleaned and DRYed up %>
AmCharts.ready(function() {
  var chartData = <%= to_js(chart.data) %>;
  var chart = new <%= chart.amchart_type %>;
  chart.dataProvider = chartData;
  chart.categoryField = '<%= chart.category_field %>';

  <% chart.settings.each do |name, value| %>
    chart.<%= name.camelize(:lower) %> = <%= to_js(value) %>;
  <% end %>

  <% if chart.pie? %>
    chart.valueField = '<%= chart.value_field %>';
    chart.titleField = '<%= chart.title_field %>';
  <% else %>
    <% chart.graphs.each.with_index do |g, index| -%>
      var graph<%= index %> = new AmCharts.AmGraph();
      graph<%= index %>.valueField = '<%= g.value_field %>';
      graph<%= index %>.type = '<%= g.type %>';
      chart.addGraph(graph<%= index %>);
    <% end %>
  <% end %>

  <% unless chart.legends.empty? %>
    <% chart.legends.each.with_index do |l, index| %>
      var legend<%= index %> = new AmCharts.AmLegend();
      <% l.settings.each do |name, value| %>
        legend<%= index %>.<%= name.camelize(:lower) %> = <%= to_js(value) %>;
      <% end %>
      chart.addLegend(legend<%= index %>);
    <% end %>
  <% end %>

  <% unless chart.titles.empty? %>
    <% chart.titles.each do |(title, options)| %>
      chart.addTitle("<%= escape_javascript(title) %>", <%= to_js(options[:size]) %>, <%= to_js(options[:color]) %>, <%= to_js(options[:alpha]) %>, <%= to_js(options[:bold]) %>);
    <% end %>
  <% end %>

  chart.write('<%= container %>');
});